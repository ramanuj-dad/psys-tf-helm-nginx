apiVersion: batch/v1
kind: Job
metadata:
  name: nginx-ingress-deployment-ACTION_PLACEHOLDER
  namespace: deployment-automation
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 1
  template:
    spec:
      serviceAccountName: nginx-ingress-deployer
      restartPolicy: Never
      containers:
      - name: deployer
        image: IMAGE_PLACEHOLDER
        env:
        - name: ACTION
          value: "ACTION_PLACEHOLDER"
        - name: CLUSTER_IP
          value: "CLUSTER_IP_PLACEHOLDER"
        command: ["/bin/bash", "-c"]
        args:
        - |
          set -e
          echo "ğŸš€ NGINX Ingress Deployment Started"
          echo "Action: $ACTION"
          echo "Cluster IP: $CLUSTER_IP"
          
          cd /workspace/terraform
          
          if [ "$ACTION" = "apply" ]; then
            echo "ğŸ“‹ Initializing Terraform..."
            terraform init
            echo "ğŸ“‹ Planning Terraform deployment..."
            terraform plan -var="cluster_ip=$CLUSTER_IP"
            echo "ğŸ“‹ Applying Terraform configuration..."
            terraform apply -auto-approve -var="cluster_ip=$CLUSTER_IP"
            echo "ğŸ“‹ Terraform deployment completed!"
            terraform output
            echo "âœ… Checking deployed resources..."
            kubectl get pods -n ingress-nginx
            kubectl get svc -n ingress-nginx
            
          elif [ "$ACTION" = "destroy" ]; then
            echo "ğŸ—‘ï¸ Destroying infrastructure with Terraform..."
            terraform init
            terraform destroy -auto-approve -var="cluster_ip=$CLUSTER_IP"
            echo "âœ… Destruction completed!"
          fi
        # No volumeMounts needed as the Pod uses the service account for Kubernetes API access
