apiVersion: batch/v1
kind: Job
metadata:
  name: nginx-ingress-deployment-ACTION_PLACEHOLDER
  namespace: deployment-automation
  annotations:
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 0  # No retries on failure
  template:
    spec:
      serviceAccountName: nginx-ingress-deployer
      restartPolicy: Never
      containers:
      - name: deployer
        image: IMAGE_PLACEHOLDER
        env:
        - name: ACTION
          value: "ACTION_PLACEHOLDER"
        - name: CLUSTER_IP
          value: "CLUSTER_IP_PLACEHOLDER"
        command: ["/bin/bash", "-c"]
        args:
        - |
          # Exit immediately if any command fails
          set -e
          
          # Function to exit with error message
          function fail() {
            echo "‚ùå ERROR: $1"
            exit 1
          }
          
          echo "üöÄ NGINX Ingress Deployment Started"
          
          # Validate environment variables
          [ -z "$ACTION" ] && fail "ACTION environment variable is not set"
          [ -z "$CLUSTER_IP" ] && fail "CLUSTER_IP environment variable is not set"
          
          echo "Action: $ACTION"
          echo "Cluster IP: $CLUSTER_IP"
          
          cd /workspace/terraform || fail "Could not change to terraform directory"
          
          if [ "$ACTION" = "apply" ]; then
            echo "üìã Initializing Terraform..."
            terraform init || fail "Terraform initialization failed"
            
            echo "üìã Planning Terraform deployment..."
            terraform plan -var="cluster_ip=$CLUSTER_IP" || fail "Terraform plan failed"
            
            echo "üìã Applying Terraform configuration..."
            terraform apply -auto-approve -var="cluster_ip=$CLUSTER_IP" || fail "Terraform apply failed"
            
            echo "üìã Terraform deployment completed!"
            terraform output || echo "No outputs available"
            
            echo "‚úÖ Checking deployed resources..."
            kubectl get pods -n ingress-nginx || echo "No pods found in ingress-nginx namespace"
            kubectl get svc -n ingress-nginx || echo "No services found in ingress-nginx namespace"
            
          elif [ "$ACTION" = "destroy" ]; then
            echo "üóëÔ∏è Destroying infrastructure with Terraform..."
            terraform init || fail "Terraform initialization failed"
            terraform destroy -auto-approve -var="cluster_ip=$CLUSTER_IP" || fail "Terraform destroy failed"
            echo "‚úÖ Destruction completed!"
          else
            fail "Unknown action: $ACTION"
          fi
        # No volumeMounts needed as the Pod uses the service account for Kubernetes API access
